<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mythfall Loot Tracker</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>ðŸ§­ Mythfall Loot Tracker</h1>
    <p>View dungeon drops and live drop rates â€” always available, even when the bot is offline.</p>
  </header>

  <main>
    <section id="dungeons">
      <!-- Dungeon sections will be inserted here -->
    </section>
  </main>

  <footer>
    <p>Built by Arpee for the Mythfall community</p>
  </footer>

<script>
  const lootData = {
    "Pirate Cove": [
      "Cutlass",
      "Blunderbuss",
      "Captain's Hat",
      "Gunpowder Egg",
      "Captain's Cape",
      "Pirate Diary (Pg 1)",
      "Pirate Diary (Pg 2)"
    ],
    "Coolcrab Grotto": [
      "Coolcrab Shades",
      "Dancing Boots",
      "Wedding Band",
      "Tidal Egg",
      "Dance Notes (Pg 1)",
      "Dance Notes (Pg 2)"
    ]
    // Future dungeons can be added here
  };

  const normalize = str =>
    str.trim().replace(/â€™/g, "'").replace(/â€˜/g, "'").replace(/â€œ|â€/g, '"');

  const container = document.getElementById("dungeons");

  const dungeonOrder = ["Pirate Cove", "Coolcrab Grotto"];
  const allDungeons = Object.keys(lootData);
  const remaining = allDungeons.filter(d => !dungeonOrder.includes(d)).sort();
  const orderedDungeons = [...dungeonOrder, ...remaining];

  orderedDungeons.forEach(dungeon => {
    const drops = lootData[dungeon];
    const jsonFile = `data/${dungeon.toLowerCase().replace(/ /g, "")}.json`;

    fetch(jsonFile)
      .then(res => {
        if (!res.ok) throw new Error(`Failed to load ${jsonFile}`);
        return res.json();
      })
      .then(stats => {
        console.log(`${dungeon} Stats:`, stats);

        const section = document.createElement("section");
        section.className = "dungeon";

        const title = document.createElement("h2");
        title.textContent = dungeon;
        section.appendChild(title);

        const list = document.createElement("ul");

        const normalizedStats = {};
        if (stats.items) {
          for (const [key, value] of Object.entries(stats.items)) {
            const normalizedKey = normalize(key);
            normalizedStats[normalizedKey] = value;
            console.log(`Normalized key: "${normalizedKey}"`);
          }
        } else {
          console.warn(`Missing 'items' in ${dungeon} stats`);
        }

        drops.forEach(drop => {
          const normalizedDrop = normalize(drop);
          const stat = normalizedStats[normalizedDrop];

          let statText = "";

          if (stat) {
            const { count, rate } = stat;
            statText = `Logged: ${count} (${rate}%)`;
          } else {
            statText = `Logged: 0 (0%) â€” unlogged`;
            console.warn(`Missing stat for "${normalizedDrop}"`);
          }

          const item = document.createElement("li");
          item.innerHTML = `${drop} <span class="rate">${statText}</span>`;
          list.appendChild(item);
        });

        section.appendChild(list);
        container.appendChild(section);
      })
      .catch(err => {
        console.error(`Error loading ${dungeon} stats:`, err);
        const errorMsg = document.createElement("p");
        errorMsg.style.color = "red";
        errorMsg.textContent = `Failed to load ${dungeon} stats.`;
        container.appendChild(errorMsg);
      });
  });
</script>
</body>
</html>
